<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Host Quiz - QuizHub</title>
  <style>
*{box-sizing:border-box;}
body{font-family:Arial,sans-serif;background:#0f1112;color:#cfc5b8;display:flex;justify-content:center;align-items:flex-start;padding:15px;margin:0;min-height:100vh;}
.card{background:#24201c;padding:20px;border-radius:14px;width:100%;max-width:650px;box-shadow:0 6px 30px rgba(2,2,2,0.6);}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px;}
.mode-badge{display:inline-block;padding:4px 10px;border-radius:20px;font-size:11px;background:linear-gradient(90deg,#b65a8b,#d98ad9);color:#fff;}
.stats-bar{display:flex;gap:8px;flex-wrap:wrap;}
.stat{background:rgba(255,255,255,0.05);padding:6px 10px;border-radius:8px;font-size:11px;}
.stat-value{color:#d9b78a;font-weight:bold;}
.timer-bar{height:6px;background:#3a3632;border-radius:3px;margin-bottom:12px;overflow:hidden;}
.timer-fill{height:100%;background:linear-gradient(90deg,#5a8bb6,#8ad9d9);border-radius:3px;transition:width 0.1s linear;}
.timer-danger{background:linear-gradient(90deg,#ff6b6b,#ff8e8e)!important;}
.question-box{background:linear-gradient(135deg,#3a3632,#24201c);padding:18px;border-radius:12px;margin-bottom:15px;border:1px solid rgba(255,255,255,0.03);}
.q-number{color:rgba(255,255,255,0.4);font-size:11px;margin-bottom:6px;}
.q-text{font-size:clamp(15px,4vw,18px);color:#fff;line-height:1.5;}
.choices{display:flex;flex-direction:column;gap:8px;margin-bottom:15px;}
.choice{padding:12px;border-radius:10px;border:2px solid rgba(255,255,255,0.05);background:transparent;color:#cfc5b8;cursor:pointer;text-align:left;transition:all 0.2s;font-size:14px;min-height:48px;}
.choice:hover{background:rgba(255,255,255,0.05);border-color:rgba(255,255,255,0.1);}
.choice.correct{background:rgba(74,222,128,0.15);border-color:#4ade80;color:#4ade80;}
.choice.wrong{background:rgba(255,107,107,0.15);border-color:#ff6b6b;color:#ff6b6b;}
.choice:disabled{cursor:not-allowed;opacity:0.7;}
.live-scores{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;}
.live-scores h4{color:#b68b5a;font-size:11px;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;}
.score-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.05);flex-wrap:wrap;gap:5px;}
.score-row:last-child{border-bottom:none;}
.player-info{display:flex;align-items:center;gap:6px;font-size:13px;}
.player-score{color:#8ad9d9;font-weight:bold;font-size:13px;}
.streak-display{position:fixed;top:15px;right:15px;background:linear-gradient(135deg,#ff6b6b,#d9b78a);padding:6px 12px;border-radius:20px;font-size:12px;color:#fff;display:none;z-index:100;}
.streak-display.show{display:block;animation:pulse 0.5s;}
@keyframes pulse{0%,100%{transform:scale(1);}50%{transform:scale(1.1);}}
.points-popup{position:fixed;font-size:18px;font-weight:bold;color:#4ade80;pointer-events:none;animation:floatUp 1s forwards;z-index:100;}
@keyframes floatUp{0%{opacity:1;transform:translateY(0);}100%{opacity:0;transform:translateY(-50px);}}
.result-screen{display:none;text-align:center;}
.result-title{font-size:clamp(22px,6vw,28px);color:#d9b78a;margin-bottom:15px;}
.final-stats{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin:20px 0;}
.final-stat{background:rgba(255,255,255,0.03);padding:15px 10px;border-radius:10px;}
.final-stat-value{font-size:clamp(18px,5vw,24px);font-weight:bold;color:#d9b78a;}
.final-stat-label{color:rgba(255,255,255,0.4);font-size:11px;margin-top:4px;}
.rankings{margin:20px 0;}
.rank-item{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:rgba(255,255,255,0.03);border-radius:10px;margin:6px 0;flex-wrap:wrap;gap:8px;}
.rank-medal{font-size:20px;margin-right:8px;}
.rank-info{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
.rank-name{color:#cfc5b8;font-size:13px;}
.rank-score{color:#8ad9d9;font-weight:bold;font-size:13px;}
.btn{width:100%;padding:12px;border-radius:10px;border:none;background:linear-gradient(90deg,#b68b5a,#d9b78a);color:#fff;font-weight:600;cursor:pointer;transition:transform 0.2s;min-height:48px;}
.btn:hover{transform:scale(1.02);}
@media(max-width:480px){.card{padding:15px 12px;}.question-box{padding:15px;}.header{justify-content:center;}.stats-bar{justify-content:center;}.final-stats{gap:8px;}.final-stat{padding:12px 8px;}}
  </style>
</head>
<body>
<div class="card">
  <!-- Quiz Screen -->
  <div id="quizScreen">
    <div class="header">
      <span class="mode-badge">üéÆ Custom Quiz</span>
      <div class="stats-bar">
        <div class="stat">üèÜ <span class="stat-value" id="pointsDisplay">0</span></div>
        <div class="stat">üî• <span class="stat-value" id="streakDisplay">0</span></div>
        <div class="stat">Q: <span id="qNum">1</span>/<span id="qTotal">10</span></div>
      </div>
    </div>

    <div class="timer-bar"><div class="timer-fill" id="timerFill" style="width:100%"></div></div>

    <div class="question-box">
      <div class="q-number">Question <span id="qNumText">1</span></div>
      <div class="q-text" id="qTitle">Loading...</div>
    </div>

    <div class="choices" id="answers"></div>

    <div class="live-scores">
      <h4>üìä Live Scores</h4>
      <div id="liveScoresList"></div>
    </div>
  </div>

  <!-- Result Screen -->
  <div id="resultScreen" class="result-screen">
    <div class="result-title">üèÜ Game Complete!</div>
    <div class="final-stats">
      <div class="final-stat"><div class="final-stat-value" id="finalPoints">0</div><div class="final-stat-label">Total Points</div></div>
      <div class="final-stat"><div class="final-stat-value" id="finalCorrect">0/0</div><div class="final-stat-label">Correct</div></div>
      <div class="final-stat"><div class="final-stat-value" id="finalStreak">0</div><div class="final-stat-label">Best Streak</div></div>
      <div class="final-stat"><div class="final-stat-value" id="finalAccuracy">0%</div><div class="final-stat-label">Accuracy</div></div>
    </div>
    <div class="rankings" id="rankings"></div>
    <button class="btn" onclick="window.location.href='dashboard.html'">üè† Back to Dashboard</button>
  </div>
</div>

<div class="streak-display" id="streakPopup">üî• <span id="streakCount">0</span> Streak!</div>

  <script src="quiz.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    requireLogin();
    const userData = getCurrentUserData();
    const PLAYER_NAME = userData ? userData.name : 'Player';
    const PLAYER_AVATAR = userData ? (userData.avatar || 'üòÄ') : 'üòÄ';

    let socket = io();
    const roomCode = sessionStorage.getItem('hostRoomCode');
    const TIME_LIMIT = 30;

    let qsList = JSON.parse(sessionStorage.getItem('hostGameQuestions') || '[]');
    let index = 0, totalPoints = 0, correctCount = 0, currentStreak = 0, bestStreak = 0;
    let timerInterval, questionStartTime;

    if (!roomCode || qsList.length === 0) {
      window.location.href = 'join.html';
    }

    // Rejoin room for live scores
    socket.emit('rejoinHostRoom', { roomCode, playerName: PLAYER_NAME, playerAvatar: PLAYER_AVATAR });

    document.getElementById('qTotal').textContent = qsList.length;

    function shuffle(arr) { return arr.slice().sort(() => Math.random() - 0.5); }

    function startTimer() {
      clearInterval(timerInterval);
      let timeLeft = TIME_LIMIT;
      questionStartTime = Date.now();
      updateTimerDisplay(timeLeft);
      timerInterval = setInterval(() => {
        timeLeft--;
        updateTimerDisplay(timeLeft);
        if (timeLeft <= 0) { clearInterval(timerInterval); handleAnswer(null, null); }
      }, 1000);
    }

    function updateTimerDisplay(time) {
      const percent = (time / TIME_LIMIT) * 100;
      const fill = document.getElementById('timerFill');
      fill.style.width = percent + '%';
      fill.className = 'timer-fill' + (time <= 5 ? ' danger' : time <= 10 ? ' warning' : '');
    }

    function renderQ() {
      clearInterval(timerInterval);
      document.getElementById('qNum').textContent = index + 1;
      document.getElementById('qNumText').textContent = index + 1;
      const q = qsList[index];
      document.getElementById('qTitle').textContent = q.q;
      const area = document.getElementById('answers');
      area.innerHTML = '';
      shuffle(q.choices).forEach(c => {
        const btn = document.createElement('button');
        btn.className = 'choice';
        btn.textContent = c;
        btn.onclick = (e) => {
          Array.from(area.children).forEach(b => b.disabled = true);
          handleAnswer(c, e);
        };
        area.appendChild(btn);
      });
      startTimer();
    }

    function handleAnswer(userAnswer, event) {
      clearInterval(timerInterval);
      const q = qsList[index];
      const correct = userAnswer === q.a;
      const timeTaken = (Date.now() - questionStartTime) / 1000;

      const area = document.getElementById('answers');
      Array.from(area.children).forEach(btn => {
        if (btn.textContent === q.a) btn.classList.add('correct');
        else if (btn.textContent === userAnswer) btn.classList.add('wrong');
      });

      if (correct) {
        correctCount++;
        currentStreak++;
        if (currentStreak > bestStreak) bestStreak = currentStreak;
        const points = calculatePoints(timeTaken, currentStreak, 'classic');
        totalPoints += points;
        document.getElementById('pointsDisplay').textContent = totalPoints;
        document.getElementById('streakDisplay').textContent = currentStreak;
        if (currentStreak >= 3) {
          document.getElementById('streakCount').textContent = currentStreak;
          document.getElementById('streakPopup').classList.add('show');
          setTimeout(() => document.getElementById('streakPopup').classList.remove('show'), 1500);
        }
        if (event) showPointsPopup(points, event.clientX, event.clientY);
      } else {
        currentStreak = 0;
        document.getElementById('streakDisplay').textContent = 0;
      }

      // Send score to server
      socket.emit('hostGameAnswer', { roomCode, score: totalPoints, correct: correctCount });

      setTimeout(() => {
        index++;
        if (index >= qsList.length) finishQuiz();
        else renderQ();
      }, 1200);
    }

    function showPointsPopup(points, x, y) {
      const popup = document.createElement('div');
      popup.className = 'points-popup';
      popup.textContent = '+' + points;
      popup.style.left = x + 'px';
      popup.style.top = y + 'px';
      document.body.appendChild(popup);
      setTimeout(() => popup.remove(), 1000);
    }

    function finishQuiz() {
      clearInterval(timerInterval);
      socket.emit('hostGameFinished', { roomCode, score: totalPoints, correct: correctCount, total: qsList.length });
      document.getElementById('quizScreen').style.display = 'none';
      document.getElementById('resultScreen').style.display = 'block';
      document.getElementById('finalPoints').textContent = totalPoints;
      document.getElementById('finalCorrect').textContent = correctCount + '/' + qsList.length;
      document.getElementById('finalStreak').textContent = bestStreak;
      document.getElementById('finalAccuracy').textContent = Math.round((correctCount / qsList.length) * 100) + '%';
    }

    // Live scores update
    socket.on('hostLiveScores', (data) => {
      const list = document.getElementById('liveScoresList');
      const sorted = Object.values(data.scores).sort((a, b) => b.score - a.score);
      list.innerHTML = sorted.map(p => `
        <div class="score-row">
          <div class="player-info">
            <span>${p.avatar}</span>
            <span>${p.name}${p.name === PLAYER_NAME ? ' (You)' : ''}</span>
          </div>
          <span class="player-score">${p.score} pts</span>
        </div>
      `).join('');
    });

    // Final results
    socket.on('hostGameResults', (data) => {
      const rankings = document.getElementById('rankings');
      const medals = ['ü•á', 'ü•à', 'ü•â'];
      const sorted = data.results.sort((a, b) => b.score - a.score);
      rankings.innerHTML = '<h3 style="color:#ffd700;">üèÜ Final Rankings</h3>' + sorted.map((p, i) => `
        <div class="rank-item">
          <div class="rank-info">
            <span class="rank-medal">${medals[i] || 'üéÆ'}</span>
            <span>${p.avatar}</span>
            <span style="color:#d9b78a;">${p.name}${p.name === PLAYER_NAME ? ' (You)' : ''}</span>
          </div>
          <span class="rank-score">${p.score} pts</span>
        </div>
      `).join('');
    });

    // Start quiz
    renderQ();
  </script>
</body>
</html>

