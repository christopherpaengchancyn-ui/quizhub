<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Multiplayer Quiz - QuizHub</title>
<style>
body{font-family:Arial,sans-serif;background:#0f1112;color:#cfc5b8;display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0;padding:20px;box-sizing:border-box;}
.card{background:#24201c;padding:30px;border-radius:14px;width:650px;max-width:100%;box-shadow:0 6px 30px rgba(2,2,2,0.6);}
h2{color:#d9b78a;margin-bottom:15px;}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;flex-wrap:wrap;gap:10px;}
.mode-badge{display:inline-block;padding:4px 10px;border-radius:20px;font-size:12px;background:linear-gradient(90deg,#b65a8b,#d98ad9);}
.cat-badge{background:rgba(255,255,255,0.1);padding:4px 10px;border-radius:20px;font-size:12px;}
.stats-bar{display:flex;gap:15px;margin-bottom:15px;flex-wrap:wrap;}
.stat{background:rgba(255,255,255,0.05);padding:8px 12px;border-radius:8px;font-size:12px;}
.stat-value{color:#d9b78a;font-weight:bold;}
.answers{display:flex;flex-direction:column;gap:10px;margin-bottom:12px;}
.choice{padding:14px;border-radius:10px;border:2px solid rgba(255,255,255,0.05);background:transparent;color:#cfc5b8;cursor:pointer;text-align:left;transition:all 0.2s;font-size:15px;}
.choice:hover{background:rgba(255,255,255,0.05);border-color:rgba(255,255,255,0.1);}
.muted{color:rgba(255,255,255,0.5);}
.timer-bar{height:8px;background:#3a3632;border-radius:4px;margin-bottom:15px;overflow:hidden;}
.timer-fill{height:100%;background:linear-gradient(90deg,#b65a8b,#d98ad9);border-radius:4px;transition:width 0.1s linear;}
.timer-danger{background:linear-gradient(90deg,#ff6b6b,#ff8e8e)!important;}
.btn{padding:12px 16px;border-radius:10px;border:none;background:linear-gradient(90deg,#b68b5a,#d9b78a);color:#fff;cursor:pointer;font-weight:600;margin:5px;transition:transform 0.2s;}
.btn:hover{transform:scale(1.02);}
.player{display:flex;align-items:center;gap:10px;background:rgba(182,139,90,0.15);padding:10px 15px;border-radius:10px;margin:8px 0;}
.player.winner{background:rgba(255,215,0,0.2);border:1px solid rgba(255,215,0,0.3);}
.player-rank{font-size:20px;}
.player-info{flex:1;}
.player-name{font-weight:600;}
.player-score{text-align:right;font-size:18px;color:#d9b78a;font-weight:bold;}
.loader{width:50px;height:50px;border:4px solid rgba(255,255,255,0.1);border-top:4px solid #d98ad9;border-radius:50%;animation:spin 1s linear infinite;margin:20px auto;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
.live-scores{background:rgba(255,255,255,0.03);padding:15px;border-radius:10px;margin-top:15px;}
.live-scores h4{margin:0 0 10px 0;color:#b68b5a;font-size:12px;text-transform:uppercase;}
.live-player{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid rgba(255,255,255,0.05);}
.player-count{font-size:14px;color:#d98ad9;margin-top:10px;}
</style>
</head>
<body>
<script src="/socket.io/socket.io.js"></script>
<div class="card">
  <!-- Waiting Screen -->
  <div id="waitingScreen">
    <div class="mode-badge">ğŸ‘¥ Multiplayer</div>
    <h2>Waiting for players...</h2>
    <p class="muted">Category: <span id="waitingCat">-</span></p>
    <p class="muted">Mode: <span id="waitingMode">Classic</span></p>
    <div class="loader"></div>
    <p class="player-count">Players in room: <span id="playerCount">1</span></p>
    <p class="muted" style="font-size:12px;margin-top:20px;">Share this page with a friend to play together!</p>
    <button class="btn" onclick="window.location.href='dashboard.html'" style="margin-top:15px;">â† Cancel</button>
  </div>

  <!-- Quiz Screen -->
  <div id="quizScreen" style="display:none;">
    <div class="header">
      <div>
        <span class="mode-badge" id="modeBadge">ğŸ‘¥ Multiplayer</span>
        <span class="cat-badge" id="catBadge">ğŸ“š Category</span>
      </div>
      <div class="stat">Q: <span id="qNum">1</span>/<span id="qTotal">10</span></div>
    </div>
    <div class="stats-bar">
      <div class="stat">ğŸ† Points: <span class="stat-value" id="pointsDisplay">0</span></div>
      <div class="stat">ğŸ”¥ Streak: <span class="stat-value" id="streakDisplay">0</span></div>
      <div class="stat">â±ï¸ <span id="timerText">30s</span></div>
    </div>
    <div class="timer-bar"><div class="timer-fill" id="timerFill" style="width:100%"></div></div>
    <h2 id="qTitle">Question</h2>
    <div class="answers" id="answers"></div>
    <div class="live-scores" id="liveScores">
      <h4>ğŸ† Live Scores</h4>
      <div id="liveScoresList"></div>
    </div>
  </div>

  <!-- Result Screen -->
  <div id="resultScreen" style="display:none;">
    <h2>ğŸ† Match Results</h2>
    <div id="scoreSummary"></div>
    <button class="btn" onclick="window.location.href='dashboard.html'">â† Back to Dashboard</button>
    <button class="btn" onclick="location.reload()">ğŸ”„ Play Again</button>
  </div>
</div>

<script src="quiz.js"></script>
<script>
// ----------------- Configuration -----------------
const TIME_LIMIT = 30;

// ----------------- User Data -----------------
const userData = getCurrentUserData();
const PLAYER_NAME = userData ? userData.name : 'Player';
const PLAYER_AVATAR = userData ? userData.avatar : 'ğŸ˜';

// ----------------- Quiz State -----------------
let category = sessionStorage.getItem('quizDiff') || 'Easy'; // Using quizDiff for backward compat
let gameMode = sessionStorage.getItem('gameMode') || 'classic';
let roomKey = `${category}_${gameMode}`;
let qsList = [];
let index = 0, totalPoints = 0, correctCount = 0, currentStreak = 0;
let timerInterval, questionStartTime;
let socket;

// ----------------- Helpers -----------------
function shuffle(arr){ return arr.slice().sort(() => Math.random() - 0.5); }

// ----------------- Timer -----------------
function startTimer(){
  clearInterval(timerInterval);
  let timeLeft = TIME_LIMIT;
  questionStartTime = Date.now();
  updateTimerDisplay(timeLeft);

  timerInterval = setInterval(() => {
    timeLeft--;
    updateTimerDisplay(timeLeft);
    if(timeLeft <= 0){
      clearInterval(timerInterval);
      handleAnswer(null);
    }
  }, 1000);
}

function updateTimerDisplay(timeLeft){
  const percent = (timeLeft / TIME_LIMIT) * 100;
  document.getElementById('timerText').innerText = `${timeLeft}s`;
  document.getElementById('timerFill').style.width = percent + '%';
  document.getElementById('timerFill').classList.toggle('timer-danger', timeLeft <= 5);
}

// ----------------- Update Stats Display -----------------
function updateStatsDisplay(){
  document.getElementById('pointsDisplay').innerText = totalPoints;
  document.getElementById('streakDisplay').innerText = currentStreak;
  document.getElementById('qNum').innerText = index + 1;
}

// ----------------- Render Question -----------------
function renderQ(){
  clearInterval(timerInterval);
  updateStatsDisplay();
  const q = qsList[index];
  document.getElementById('qTitle').innerText = q.q;
  const area = document.getElementById('answers');
  area.innerHTML = '';

  shuffle(q.choices).forEach(c => {
    const btn = document.createElement('button');
    btn.className = 'choice';
    btn.innerText = c;
    btn.onclick = () => {
      Array.from(area.children).forEach(b => b.disabled = true);
      handleAnswer(c);
    };
    area.appendChild(btn);
  });

  startTimer();
}

// ----------------- Handle Answer -----------------
function handleAnswer(userAnswer){
  clearInterval(timerInterval);
  const q = qsList[index];
  const correct = userAnswer === q.a;
  const timeTaken = (Date.now() - questionStartTime) / 1000;

  // Highlight correct/wrong
  const area = document.getElementById('answers');
  Array.from(area.children).forEach(btn => {
    if(btn.innerText === q.a) btn.style.background = 'rgba(0,255,0,0.3)';
    else if(btn.innerText === userAnswer) btn.style.background = 'rgba(255,0,0,0.3)';
  });

  if(correct){
    correctCount++;
    currentStreak++;
    // Points calculated on server
  } else {
    currentStreak = 0;
  }

  // Send to server
  socket.emit('answer', { roomKey, correct, timeTaken });

  updateStatsDisplay();
  setTimeout(nextQuestion, 700);
}

// ----------------- Next Question -----------------
function nextQuestion(){
  index++;
  if(index >= qsList.length) finishQuiz();
  else renderQ();
}

// ----------------- Finish Quiz -----------------
function finishQuiz(){
  clearInterval(timerInterval);
  socket.emit('finish', { roomKey });
}

// ----------------- Multiplayer Setup -----------------
socket = io();

// Player count update
socket.on('playerCount', (count) => {
  document.getElementById('playerCount').innerText = count;
});

// Quiz starts
socket.on('startQuiz', (data) => {
  qsList = data.questions;
  category = data.category;
  gameMode = data.gameMode;
  roomKey = `${category}_${gameMode}`;

  document.getElementById('qTotal').innerText = qsList.length;
  document.getElementById('waitingScreen').style.display = 'none';
  document.getElementById('quizScreen').style.display = 'block';
  renderQ();
});

// Live scores update
socket.on('liveScores', (scores) => {
  const list = document.getElementById('liveScoresList');
  list.innerHTML = scores.map(p =>
    `<div class="live-player"><span>${p.avatar || 'ğŸ˜'} ${p.name}</span><span>${p.points} pts</span></div>`
  ).join('');

  // Update own points
  const myScore = scores.find(p => p.name === PLAYER_NAME);
  if(myScore) totalPoints = myScore.points;
  updateStatsDisplay();
});

// Match results
socket.on('matchResult', (results) => {
  document.getElementById('quizScreen').style.display = 'none';
  document.getElementById('resultScreen').style.display = 'block';

  document.getElementById('scoreSummary').innerHTML = results.map((p, i) => {
    const rankIcon = i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : (i + 1);
    const isWinner = i === 0;
    const isMe = p.name === PLAYER_NAME;
    return `<div class="player ${isWinner ? 'winner' : ''}" ${isMe ? 'style="border:1px solid #d9b78a;"' : ''}>
      <span class="player-rank">${rankIcon}</span>
      <div class="player-info">
        <div class="player-name">${p.avatar || 'ğŸ˜'} ${p.name} ${isMe ? '(You)' : ''}</div>
        <div class="muted">${p.score}/${qsList.length} correct</div>
      </div>
      <div class="player-score">${p.points} pts</div>
    </div>`;
  }).join('');

  // Update user stats
  const myResult = results.find(p => p.name === PLAYER_NAME);
  if(myResult){
    updateUserStats({
      gamesPlayed: 1,
      wins: results[0].name === PLAYER_NAME ? 1 : 0,
      totalScore: myResult.points,
      bestStreak: currentStreak
    });
  }
});

// Game over (survival mode)
socket.on('gameOver', (data) => {
  document.getElementById('quizScreen').style.display = 'none';
  document.getElementById('resultScreen').style.display = 'block';
  document.getElementById('scoreSummary').innerHTML = `
    <div style="text-align:center;padding:20px;">
      <h3 style="color:#ff6b6b;">ğŸ’€ Game Over!</h3>
      <p>You answered incorrectly in Survival mode</p>
      <p style="font-size:24px;color:#d9b78a;">${data.points} points</p>
      <p class="muted">${data.score} questions answered</p>
    </div>`;
});

// Join room on load
socket.emit('joinRoom', {
  name: PLAYER_NAME,
  category: category,
  gameMode: gameMode,
  avatar: PLAYER_AVATAR
});

// ----------------- Initialize UI -----------------
document.getElementById('waitingCat').innerText = category;
document.getElementById('waitingMode').innerText = gameMode.charAt(0).toUpperCase() + gameMode.slice(1);
document.getElementById('catBadge').innerText = `ğŸ“š ${category}`;
document.getElementById('quizScreen').style.display = 'none';
document.getElementById('resultScreen').style.display = 'none';
</script>
</body>
</html>
